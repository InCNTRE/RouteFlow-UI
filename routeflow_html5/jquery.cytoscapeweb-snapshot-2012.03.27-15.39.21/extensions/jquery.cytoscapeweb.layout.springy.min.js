
/* jquery.cytoscapeweb.layout.springy.min.js */

/**
 * This file is part of Cytoscape Web snapshot-2012.03.27-15.39.21.
 * 
 * Cytoscape Web is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 * 
 * Cytoscape Web is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License along with
 * Cytoscape Web. If not, see <http://www.gnu.org/licenses/>.
 */
 
(function(d,k){var b={maxSimulationTime:1000,ungrabifyWhileSimulating:true,fit:true,random:false};function h(){d.cytoscapeweb("debug","Creating Springy layout with options")}function a(l){if(l!=null&&typeof l==typeof function(){}){l()}}h.prototype.run=function(F){var s=d.extend(true,{},b,F);d.cytoscapeweb("debug","Running Springy layout with options (%o)",s);var r=F.cy;var A=r.nodes();var q=r.edges();var w=r.container();var o=new i();A.each(function(I,J){J.scratch("springy",{model:o.newNode({element:J})})
});q.each(function(I,J){fdSrc=J.source().scratch("springy.model");fdTgt=J.target().scratch("springy.model");J.scratch("springy",{model:o.newEdge(fdSrc,fdTgt,{element:J})})});var E=new j.ForceDirected(o,400,400,0.5);var p=E.getBoundingBox();var v={bottomleft:new Vector(-2,-2),topright:new Vector(2,2)};var D=function(J){var I=p.topright.subtract(p.bottomleft);var L=J.subtract(p.bottomleft).divide(I.x).x*w.width();var K=J.subtract(p.bottomleft).divide(I.y).y*w.height();return new Vector(L,K)};var m=function(L){var K=p.topright.subtract(p.bottomleft);
var J=(L.x/w.width())*K.x+p.bottomleft.x;var I=(L.y/w.height())*K.y+p.bottomleft.y;return new Vector(J,I)};var l=r.collection();var z=r.nodes().size();var G=1;var H=new c(10,E,function y(){},function u(I,K,J){},function C(K,L){var I=D(L);var J=K.data.element;window.p=L;window.n=K;if(!J.locked()){J._private.position={x:I.x,y:I.y};l=l.add(J)}else{x(J)}if(G==z){r.trigger("layoutready");a(F.ready)}G++});A.each(function(I,J){if(!s.random){x(J)}});setInterval(function(){if(l.size()>0){l.rtrigger("position");
l=r.collection()}},50);A.bind("drag",function(){x(this)});function x(J){var M=J.scratch("springy.model").id;var K=H.layout.nodePoints[M].p;var L=J.position(false);var I=(L.x!=null&&L.y!=null)?m(J.position(false)):{x:Math.random()*4-2,y:Math.random()*4-2};K.x=I.x;K.y=I.y}var n=A.filter(":grabbable");function t(){if(s.ungrabifyWhileSimulating){n.ungrabify()}H.start()}function B(I){o.filterNodes(function(){return false});setTimeout(function(){if(s.ungrabifyWhileSimulating){n.grabify()}I()},100)}t();
setTimeout(function(){B(function(){if(s.fit){r.fit()}r.trigger("layoutstop");a(F.stop)})},s.maxSimulationTime)};d.cytoscapeweb("layout","springy",h);var i=function(){this.nodeSet={};this.nodes=[];this.edges=[];this.adjacency={};this.nextNodeId=0;this.nextEdgeId=0;this.eventListeners=[]};var g=function(m,l){this.id=m;this.data=typeof(l)!=="undefined"?l:{}};var e=function(o,m,n,l){this.id=o;this.source=m;this.target=n;this.data=typeof(l)!=="undefined"?l:{}};i.prototype.addNode=function(l){if(typeof(this.nodeSet[l.id])==="undefined"){this.nodes.push(l)
}this.nodeSet[l.id]=l;this.notify();return l};i.prototype.addEdge=function(m){var l=false;this.edges.forEach(function(n){if(m.id===n.id){l=true}});if(!l){this.edges.push(m)}if(typeof(this.adjacency[m.source.id])==="undefined"){this.adjacency[m.source.id]={}}if(typeof(this.adjacency[m.source.id][m.target.id])==="undefined"){this.adjacency[m.source.id][m.target.id]=[]}l=false;this.adjacency[m.source.id][m.target.id].forEach(function(n){if(m.id===n.id){l=true}});if(!l){this.adjacency[m.source.id][m.target.id].push(m)
}this.notify();return m};i.prototype.newNode=function(m){var l=new g(this.nextNodeId++,m);this.addNode(l);return l};i.prototype.newEdge=function(n,o,m){var l=new e(this.nextEdgeId++,n,o,m);this.addEdge(l);return l};i.prototype.getEdges=function(m,l){if(typeof(this.adjacency[m.id])!=="undefined"&&typeof(this.adjacency[m.id][l.id])!=="undefined"){return this.adjacency[m.id][l.id]}return[]};i.prototype.removeNode=function(m){if(typeof(this.nodeSet[m.id])!=="undefined"){delete this.nodeSet[m.id]}for(var l=this.nodes.length-1;
l>=0;l--){if(this.nodes[l].id===m.id){this.nodes.splice(l,1)}}this.detachNode(m)};i.prototype.detachNode=function(l){var m=this.edges.slice();m.forEach(function(n){if(n.source.id===l.id||n.target.id===l.id){this.removeEdge(n)}},this);this.notify()};i.prototype.removeEdge=function(p){for(var o=this.edges.length-1;o>=0;o--){if(this.edges[o].id===p.id){this.edges.splice(o,1)}}for(var l in this.adjacency){for(var q in this.adjacency[l]){var m=this.adjacency[l][q];for(var n=m.length-1;n>=0;n--){if(this.adjacency[l][q][n].id===p.id){this.adjacency[l][q].splice(n,1)
}}}}this.notify()};i.prototype.merge=function(m){var l=[];m.nodes.forEach(function(o){l.push(this.addNode(new g(o.id,o.data)))},this);m.edges.forEach(function(o){var r=l[o.from];var q=l[o.to];var p=(o.directed)?(p=o.type+"-"+r.id+"-"+q.id):(r.id<q.id)?o.type+"-"+r.id+"-"+q.id:o.type+"-"+q.id+"-"+r.id;var n=this.addEdge(new e(p,r,q,o.data));n.data.type=o.type},this)};i.prototype.filterNodes=function(l){var m=this.nodes.slice();m.forEach(function(o){if(!l(o)){this.removeNode(o)}},this)};i.prototype.filterEdges=function(l){var m=this.edges.slice();
m.forEach(function(n){if(!l(n)){this.removeEdge(n)}},this)};i.prototype.addGraphListener=function(l){this.eventListeners.push(l)};i.prototype.notify=function(){this.eventListeners.forEach(function(l){l.graphChanged()})};var j={};j.ForceDirected=function(o,l,m,n){this.graph=o;this.stiffness=l;this.repulsion=m;this.damping=n;this.nodePoints={};this.edgeSprings={}};j.ForceDirected.prototype.point=function(m){if(typeof(this.nodePoints[m.id])==="undefined"){var l=typeof(m.data.mass)!=="undefined"?m.data.mass:1;
this.nodePoints[m.id]=new j.ForceDirected.Point(Vector.random(),l)}return this.nodePoints[m.id]};j.ForceDirected.prototype.spring=function(m){if(typeof(this.edgeSprings[m.id])==="undefined"){var l=typeof(m.data.length)!=="undefined"?m.data.length:1;var n=false;var p=this.graph.getEdges(m.source,m.target);p.forEach(function(q){if(n===false&&typeof(this.edgeSprings[q.id])!=="undefined"){n=this.edgeSprings[q.id]}},this);if(n!==false){return new j.ForceDirected.Spring(n.point1,n.point2,0,0)}var o=this.graph.getEdges(m.target,m.source);
p.forEach(function(q){if(n===false&&typeof(this.edgeSprings[q.id])!=="undefined"){n=this.edgeSprings[q.id]}},this);if(n!==false){return new j.ForceDirected.Spring(n.point2,n.point1,0,0)}this.edgeSprings[m.id]=new j.ForceDirected.Spring(this.point(m.source),this.point(m.target),l,this.stiffness)}return this.edgeSprings[m.id]};j.ForceDirected.prototype.eachNode=function(m){var l=this;this.graph.nodes.forEach(function(o){m.call(l,o,l.point(o))})};j.ForceDirected.prototype.eachEdge=function(m){var l=this;
this.graph.edges.forEach(function(n){m.call(l,n,l.spring(n))})};j.ForceDirected.prototype.eachSpring=function(m){var l=this;this.graph.edges.forEach(function(n){m.call(l,l.spring(n))})};j.ForceDirected.prototype.applyCoulombsLaw=function(){this.eachNode(function(m,l){this.eachNode(function(o,n){if(l!==n){var q=l.p.subtract(n.p);var r=q.magnitude()+0.1;var p=q.normalise();l.applyForce(p.multiply(this.repulsion).divide(r*r*0.5));n.applyForce(p.multiply(this.repulsion).divide(r*r*-0.5))}})})};j.ForceDirected.prototype.applyHookesLaw=function(){this.eachSpring(function(l){var o=l.point2.p.subtract(l.point1.p);
var m=l.length-o.magnitude();var n=o.normalise();l.point1.applyForce(n.multiply(l.k*m*-0.5));l.point2.applyForce(n.multiply(l.k*m*0.5))})};j.ForceDirected.prototype.attractToCentre=function(){this.eachNode(function(m,l){var n=l.p.multiply(-1);l.applyForce(n.multiply(this.repulsion/50))})};j.ForceDirected.prototype.updateVelocity=function(l){this.eachNode(function(n,m){m.v=m.v.add(m.a.multiply(l)).multiply(this.damping);m.a=new Vector(0,0)})};j.ForceDirected.prototype.updatePosition=function(l){this.eachNode(function(n,m){m.p=m.p.add(m.v.multiply(l))
})};j.ForceDirected.prototype.totalEnergy=function(l){var m=0;this.eachNode(function(o,n){var p=n.v.magnitude();m+=0.5*n.m*p*p});return m};var f=function(l,m){return function(){return l.apply(m,arguments)}};j.requestAnimationFrame=f(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(m,l){window.setTimeout(m,10)},window);j.ForceDirected.prototype.start=function(m,o,l){var n=this;
if(this._started){return}this._started=true;j.requestAnimationFrame(function p(){n.applyCoulombsLaw();n.applyHookesLaw();n.attractToCentre();n.updateVelocity(0.03);n.updatePosition(0.03);if(typeof(o)!=="undefined"){o()}if(n.totalEnergy()<0.01){n._started=false;if(typeof(l)!=="undefined"){l()}}else{j.requestAnimationFrame(p)}})};j.ForceDirected.prototype.nearest=function(n){var m={node:null,point:null,distance:null};var l=this;this.graph.nodes.forEach(function(q){var o=l.point(q);var p=o.p.subtract(n).magnitude();
if(m.distance===null||p<m.distance){m={node:q,point:o,distance:p}}});return m};j.ForceDirected.prototype.getBoundingBox=function(){var l=new Vector(-2,-2);var n=new Vector(2,2);this.eachNode(function(p,o){if(o.p.x<l.x){l.x=o.p.x}if(o.p.y<l.y){l.y=o.p.y}if(o.p.x>n.x){n.x=o.p.x}if(o.p.y>n.y){n.y=o.p.y}});var m=n.subtract(l).multiply(0.07);return{bottomleft:l.subtract(m),topright:n.add(m)}};Vector=function(l,m){this.x=l;this.y=m};Vector.random=function(){return new Vector(10*(Math.random()-0.5),10*(Math.random()-0.5))
};Vector.prototype.add=function(l){return new Vector(this.x+l.x,this.y+l.y)};Vector.prototype.subtract=function(l){return new Vector(this.x-l.x,this.y-l.y)};Vector.prototype.multiply=function(l){return new Vector(this.x*l,this.y*l)};Vector.prototype.divide=function(l){return new Vector((this.x/l)||0,(this.y/l)||0)};Vector.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector.prototype.normal=function(){return new Vector(-this.y,this.x)};Vector.prototype.normalise=function(){return this.divide(this.magnitude())
};j.ForceDirected.Point=function(l,m){this.p=l;this.m=m;this.v=new Vector(0,0);this.a=new Vector(0,0)};j.ForceDirected.Point.prototype.applyForce=function(l){this.a=this.a.add(l.divide(this.m))};j.ForceDirected.Spring=function(n,m,o,l){this.point1=n;this.point2=m;this.length=o;this.k=l};function c(m,p,l,o,n){this.interval=m;this.layout=p;this.clear=l;this.drawEdge=o;this.drawNode=n;this.layout.graph.addGraphListener(this)}c.prototype.graphChanged=function(l){this.start()};c.prototype.start=function(){var l=this;
this.layout.start(50,function m(){l.clear();l.layout.eachEdge(function(o,n){l.drawEdge(o,n.point1.p,n.point2.p)});l.layout.eachNode(function(o,n){l.drawNode(o,n.p)})})}})(jQuery,jQuery.cytoscapeweb);